
# 持续集成

# 持续部署
# 监控
# 日志


# 部署

## 滚动更新
滚动更新是指逐步替换实例的过程，一次更新一部分实例，直到所有实例都更新完成。

特点：
- 渐进式更新：一次只更新一部分实例，其余实例继续提供服务
- 资源利用率高：不需要准备完整的额外环境
- 更新过程中新旧版本共存：需要考虑版本兼容性问题
适用场景：

- 资源有限的环境
- 可以接受短暂的部分服务降级
- 新旧版本兼容性较好的系统
### 简单更新
docker-compose up --no-deps -d nz-server
**执行逻辑**
1. **读取 `docker-compose.yml`**，检查 `nz-server` 的配置是否有变化（如 `image`、`environment` 等）。
2. **停止旧容器**（如果存在）。
3. **启动新容器**（使用新配置）。
4. **不处理依赖服务**（`--no-deps`）。
**特点**
✅ **优点**：
- **简单快捷**，一条命令完成更新。
- **不干扰其他容器**（适合独立服务）。
- **自动处理旧容器**（Docker 会清理旧实例）。
❌ **缺点**：
- **没有滚动更新**，直接替换容器，可能导致短暂服务中断。
- **不控制新/旧容器并行数量**，无法实现零宕机更新。
- **依赖 Docker Compose 管理**，不适合复杂编排场景（如 Kubernetes）。    
**适用场景**
- 开发/测试环境快速更新。
- 服务允许短暂中断（如后台任务）。
- 不需要精细控制更新策略。

### 手动更新

1. 修改 docker-compose.yml（如更新镜像版本）
2. 获取当前运行的旧容器 ID（docker ps -q --filter "name=nz-server"）
3. 启动新版本容器（数量 > 旧容器，例如 2 个新实例 + 1 个旧实例）
4. 逐步停止旧容器（docker stop old-container-id）
5. 清理旧容器（docker rm old-container-id）
6. 调整容器数量至期望值（docker compose scale nz-server）

**特点**
✅ **优点**：
- **实现零宕机更新**（新容器就绪后再停旧容器）。
- **精细控制更新过程**（如分批替换、流量切换）。
- **兼容性更强**（可用于非 Docker Compose 环境）。
❌ **缺点**：
- **流程复杂**，需手动或脚本控制。
- **依赖外部负载均衡**（如 Nginx、Traefik）做流量分发。
- **需要监控健康状态**（确保新容器启动成功后再停旧容器）。
**适用场景**
- 生产环境高可用服务（如 Web API、微服务）。
- 需要避免服务中断的场景。
- 复杂部署策略（如金丝雀发布、A/B 测试）。

### **核心区别总结**


|          | `docker-compose up --no-deps -d` | 手动滚动更新         |
| -------- | -------------------------------- | -------------- |
| **更新方式** | 直接替换                             | 分批替换（新旧并存）     |
| **服务中断** | 可能短暂中断                           | 接近零宕机          |
| **复杂度**  | 简单                               | 较高（需脚本/工具）     |
| **适用场景** | 开发/测试                            | 生产环境           |
| **依赖管理** | 仅限 Docker Compose                | 通用（可结合 LB、K8s） |
### **如何选择？**
1. **开发/测试环境** → 直接用 `docker-compose up --no-deps -d`。
2. **生产环境无状态服务** → 可结合 `docker-compose up --scale nz-server=3` 实现简单滚动更新。
3. **生产环境关键服务** → 使用 **手动滚动更新** 或迁移到 Kubernetes（支持原生 Rolling Update）


## 蓝绿部署
蓝绿部署是指维护两套完全相同的环境，一套是当前运行的生产环境（蓝），另一套是准备更新的新环境（绿）。

特点：

- 一次性切换：新版本部署完成后，通过修改负载均衡器配置，将流量从蓝环境一次性切换到绿环境
- 环境隔离：新旧版本完全分离，不会相互影响
- 回滚简单：如果发现问题，只需将流量切回蓝环境即可
适用场景：

- 需要零停机时间的关键业务
- 对版本兼容性要求高的系统
- 资源充足的情况下

## 金丝雀发布