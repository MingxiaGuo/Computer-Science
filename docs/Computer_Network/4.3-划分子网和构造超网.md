### 4.3.1 划分子网
#### 4.3.1.1 从二级IP地址到三级IP地址

⑴、IP 地址设计不合理的地方：
①.IP地址空间的利用率有时很低，浪费严重；
②.为每个物理网络分配一个网络号会使路由表太大；
③.二级IP地址不够灵活，要增加一个新网络必须申请IP地址；
为解决以上问题，将2级地址中又增加一个“子网号字段”，变成三级地址，该方法称为划分子网。该方法已成标准。 

⑵、划分子网的思路：
①.划分子网是一个单位内部事情，对外仍表现为一个网络。
②.划分子网是从主机号中借用若干位作子网号；

③.外部网络发来的数据报根据网络号找到目的主机所在网络的路由器，目的主机所在网络的路由器根据目的网络号和子网号找到目的子网，把数据报交给目的主机。
【例题4.2】某单位拥有一个B类地址：145.13.0.0

划分子网前单位网络拓扑
该结构中，所有机器均在同一网络中，不利于管理，且一个局域网所接主机数量也是有限的。 

划分子网后的拓扑（假设：子网号占8位）
划分子网后，整个网络对外仍表现为一个网络，R1、R2上的路由表不必因划分子网而变动，R3根据子网转发。

#### 4.3.1.2 子网掩码 

源主机并不知目的网络是否划分子网，目的网络的路由器如何把数据报被转发到子网？借助于子网掩码。
⑴、子网掩码的定义：
①.子网掩码中的1对应于IP地址中原来的网络号和子网号，0对应主机号；
网络地址 ＝（IP 地址） AND （子网掩码） 
②.子网掩码中子网号对应部分的1可以不连续，但是推荐子网号的1连续；
【例题4.3】ip地址如下图所示，求子网地址？

⑵、子网掩码的特征
①.为了方便查找路由，即使网络没有划分子网，也要使用子网掩码。这时的子网掩码称为默认的子网掩码。1对应的网络号，0对应主机号，无子网号对应。
A类的默认子网掩码255.0.0.0
B类的默认子网掩码255.255.0.0
C类的默认子网掩码255.255.255.0
   	②.不论有没有划分子网，子网掩码与目的IP地址逐位相与得到网络地址。
③.相邻路由器交换路由信息时必须把自己所在的网络的子网掩码告诉相邻的路由器。
④.划分子网时可以采用固定长度表示子网号，此时所有子网的子网掩码相同。也可采用变长子网划分方法。 RFC(Request for Comments请求注解，介绍internet最重要的文献资源) 规定子网号全0或全1不用。但随着无分类域间路由协议CIDR的广泛使用，全0或全1的子网号也可用了。使用时看你的路由器是否支持全0和全1的子网。
⑤.划分子网的方法增加了灵活性，但也减少了能够连接网络的主机总数。
⑥.主机号全0 和全1分别表示本子网地址和广播地址，不分配给设备。
⑦. 子网位数为0、1、15、16无意义。
【例题4.4】已知ip地址141.14.72.24 子网掩码是255.255.192.0试求其网络地址，若子网掩码是255.255.255.0呢？



结论：不同的子网掩码可能得出相同的网络地址，但效果是不同的。 
【例题4.5】某单位获一c类地址192.168.12.0 现该单位的网络拓扑图如下所示，试为该单位划分子网。

解：第一步：确定子网数和子网主机数。
  	第二步：确定用的多少为标识子网号、多少为标识主机号。
本例中有5个子网，至少需3位表示网络号，主机号5位，可表示每位子网中最多可接30台主机。
子网掩码位：255.255.255.224；可以如下分配网络号：
LAN1 		192.168.12.32					LAN2 		192.168.12.64
LAN3 		192.168.12.96					LAN4 		192.168.12.128
LAN5 		192.168.12.160
损失地址数254-6*30=74个，可再建一个子网。

### 4.3.2 使用子网时分组转发过程
划分子网后，路由表必须包含3项内容：目的网络、子网掩码和下一跳地址；
1、路由转发分组的算法：
⑴、从收到的数据报首部提取目的IP地址D；
⑵、先判断是否为直接交付。若是，则进行直接交付；
⑶、若路由表中有目的地址为D的特定主机路由，则按路由表中指明的下一跳路由作为转发对象；
⑷、对路由表中的每一行，用其中的子网掩码和D逐位相与，其结果为网络地址N，若N与该行目的网络地址匹配，则把数据报传送给该行指明的下一跳路由器，否则执行⑸；
⑸、若表中有一默认路由，则把数据报传送给路由表中所指明的默认路由器，否则执行⑹；
⑹、报告转发分组出错；	
【例题4.6】已知互联网和路由器 R1 中的路由表。主机 H1 向 H2 发送分组。试讨论 R1 收到 H1向 H2 发送的分组后查找路由表的过程。 

解：现讨论H1想H2发送分组的过程： 
H1把本子网掩码与H2的IP 地址逐位相与得128.30.33.128 它不等于H1的网络地址，这说明H2与H1不在同一子网上，故H1把分组交给子网默认的路由器R1；
R1收到分组后，先找路由表第一行，取其目的网路地址和子网掩码相与后得到目的子网地址，看它是否和收到分组的子网地址匹配，若匹配则转发到下一跳接口，否则再找第二行，进行类似操作，最后R1把分组从接口1直接交付给主机H2。

### 4.3.3 无分类编址 CIDR（构造超网）

CIDR  无类域内路由选择（Classless Inter-Domain Routing）

#### 4.3.3.1 网路前缀

⑴、因特网仍面临着三个必须尽早解决的问题
尽管划分子网在一定程度上缓解了因特网发展中遇到的困难，但因特网仍面临着三个必须尽早解决的问题：
①.B类地址很快全部分配完毕；
②.主干网上路由表的表项急剧增大
③.IPV4地址空间最终将消耗 
在变长子网掩码基础上发展起来的CIDR技术已成为因特网建议的标准协议。
⑵、CIDR最主要的特点
①.CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。CIDR编址方法如下：

②.CIDR使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号。使用“斜线记法”，即在IP地址后加上斜线“/”,然后写上网络前缀所占位数，故斜线表示法中，斜线后面的数字就是掩码中1 的个数IP 地址从三级编址（使用子网掩码）又回到了两级编址。
③.把网络前缀都相同的连续IP地址组成一个“CIDR地址块”；
⑶、CIDR地址块已知CIDR地址块中任一地址，就可以知道这个地址块的起始地址、最大地址以及该地址块中地址总数。
【例题4.7】128.14.35.7/20 
128.14.35.7=1000 0000 0000 1110 0010 0011 0000 0111
可知最小地址为128.14.32.0
最大地址为128.14.47.255
该地址块共有212个地址。
⑷、CIDR 记法的其他形式
①.10.0.0.0/10 可简写为 10/10，也就是把点分十进制中低位连续的 0 省略。 
②.ip地址为10.0.0.0，掩码为255.192.0.0
③.网络前缀的后面加一个星号 * 的表示方法
   在星号 * 之前是网络前缀，星号 * 表示 IP 地址中的主机号，可以是任意值。如 00001010 00* ；
⑸、路由聚合(route aggregation) 
①.一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的一个项目可以表示很多个原来传统分类地址的路由。
②.路由聚合也称为构成超网(supernetting)。
③.CIDR 虽然不使用子网了，但仍然使用“掩码”这一名词（但不叫子网掩码）。
④. 为便于路由选择，CIDR使用32位的地址掩码，1对应网络前缀位，0对应主机位。如：/20地址块，它的掩码是 20 个连续的 1。 
【例题4.8】某组织分配到地址块/20，可以再从主机号中借3位来划分8个子网，每个子网网络掩码为/23.
路由器利用CIDR地址块查找目的网络，使用路由聚合技术可减少路由表项目。
【例题4.9】若192.168.4.0/24、192.168.5.0/24、192.168.6.0/24,可聚合成一条路由192.168.4.0/22,当然前提是这三个网络在该路由器上的路由相同。
若有192.168.7.0/24与它们路由不同，则不能合并成192.168.4.0/22,而只能把192.168.4.0/24与192.168.5.0/24合并成192.168.4.0/23,而192.168.6.0/24与192.168.7.0/24各自为一个单独的表项。 
⑹、CIDR地址块的子网划分
   分配到CIDR地址块的组织，仍可以在本组织内根据需要划分子网。子网也只有网络前缀和主机号，只是子网前缀比整个组织网络前缀要长一些。
【例题4.10】某ISP（Internet Service Provider互联网服务提供商）已拥有地址块206.0.64.0/18，现某大学需要800个IP地址，ISP可给该大学一个地址块206.0.68.0/22，含1024个IP 地址。这个大学可自由对本校的各系分配地址块，各系还可在划分本系的地址块。

解 ①.一系向学校申请512个地址，需9位表示主机号，故从206.0.68.0/23开始，到2060.0.69.255/23,都作为一系地址。②.二系向学校申请256个地址，需8位表示主机号，只能从206.0.70.0/24开始分配，此时206.0.71.0/24没有分出去，这有256个地址。③.三系和四系分别申请128个地址，需再拿一位区别三系和四系。
注意这个 ISP 共有 64 个 C 类网络。如果不采用 CIDR 技术，则在与该 ISP 的路由器交换路由信息的每一个路由器的路由表中，就需要有 64 个项目。但采用地址聚合后，只需用路由聚合后的 1 个项目 206.0.64.0/18 就能找到该 ISP。 

#### 4.3.3.2 最长前缀匹配

最长前缀匹配 又称为最长匹配或最佳匹配

⑴、使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能会得到不止一个匹配结果。 
⑵、应当从匹配结果中选择具有最长网络前缀的路由最长前缀匹配；
⑶、网络前缀越长，其地址块就越小，因而路由就越具体；
说明如果IP地址分配一开始就采用CIDR，那么我们可以按网络所在地理位置来分配地址块，这样可大大减少路由表中项目。但现在要收回已发地址已十分困难。
【例题4.11】如下图所示

显然：选择两个匹配的地址中更具体的一个，即选择最长前缀的地址。 

#### 4.3.3.3 用二叉线索树查找路由表

⑴、为了进行更加有效的查找，通常是将无分类编址的路由表存放在一种层次的数据结构中，然后自上而下地按层次进行查找。这里最常用的就是二叉线索；
⑵、IP 地址中从左到右的比特值决定了从根结点逐层向下层延伸的路径，而二叉线索中的各个路径就代表路由表中存放的各个地址。
⑶、为了提高二叉线索的查找速度，广泛使用了各种压缩技术。   
⑷、唯一前缀即表中所有的IP地址中，该前缀是唯一的；利用唯一前缀构造二叉线索；

匹配时只需匹配唯一前缀（表中所有的IP地址中，该前缀是唯一的），而不必匹配全部32位。当网络唯一前缀匹配后，在进行一次32位的匹配，在每个叶结点中包含对应的网络前缀和子网掩码，搜索到叶结点后，将目的地址与子网掩码相与，再看与网络前缀是否匹配。



