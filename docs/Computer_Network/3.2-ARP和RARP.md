### 4.2.4 ARP与RARP

不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用MAC地址。路由器如何知道在MAC帧中填入什么样的MAC地址？  就要用到ARP协议

ARP是通过吼的方式来寻找目标MAC地址的，吼完之后记住一段时间，这个叫作缓存；

**ARP**：地址解析协议 ARP

**RARP**：地址解析协议。现已不用，包含在DHCP（Dynamic Host Configuration Protocol，动态主机配置协议应用层协议）协议中。 

**ARP的工作原理**：主机如何知道IP地址和MAC地址对应关系呢？ 

* ARP在主机ARP高速缓存中存放一个IP地址到硬件地址的**映射表**，里面有本局域网上各种主机和路由器的IP地址到硬件地址的MAC地址映射表，这个表要动态更新。 

* 当主机A要向本局域网上的某个主机B发送IP数据报时，先查找自己的MAC地址映射表中是否有主机B对应表项。若有，查出相应的硬件地址，填入MAC帧，然后发送，若没有，A运行ARP协议找出B的MAC地址；具体步骤如下：

  * ①.A向本局域网广播一个ARP请求分组（广播帧）。注明A的IP地址和MAC地址，以及B的IP地址。

  * ②.主机B及所有本局域网主机都收到该分组。

  * ③.只有B向A发送ARP响应分组（单播帧），并注明自己的MAC地址，同时B将A的一对地址记入ARP缓存的MAC地址映射表中。

  * ④.A收到响应后在其MAC地址映射表中添加记录(为了避免每次都用ARP请求)，并使用该地址。

  * 注意 	
    * ①.每个映射地址项目都有生存时间，设想B更换网卡情况。
    * ②.ARP是解决同一局域网上的主机或路由器的IP地址和硬件地址的映射问题的。目的主机和源主机不在同一局域网时解决的方法是：源主机通过 ARP 找到一个位于本局域网上的某个路由器的MAC地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。 



<img src="https://static001.geekbang.org/resource/image/5f/68/5fe88a40a8b5d507601968efb50ac668.jpg" alt="5fe88a40a8b5d507601968efb50ac668" style="zoom:70%;" />



​	广而告之，发送一个广播包，谁是这个IP谁来回答。	具体询问和回答的报文如下：

![2bc53afb25515e96d0e646e297b1ce2f](https://static001.geekbang.org/resource/image/2b/2f/2bc53afb25515e96d0e646e297b1ce2f.jpg)

为了避免每次都用ARP请求，机器本地也会进行ARP缓存。当然机器会不断地上线下线，IP也可能会变，所以ARP的MAC地址缓存过一段时间就会过期。


⑶、归纳总结 使用ARP的四种情况：
发送方	接收方	利用ARP获得的MAC地址
主机A	同一网内的主机B	主机B的MAC地址
主机A	其它网内的主机C	本网路由器R的MAC地址，其余工作由路由器A完成
路由器R	同一网内的主机B	主机B的MAC地址
路由器R1	其它网内的主机C	本网路由器R2的MAC地址，其余工作由路由器R2完成
⑷、为什么我们不直接使用硬件地址进行通信？ 不同网络的硬件地址不同，直接利用硬件地址通信，硬件地址转换非常复杂
连接到因特网的主机都拥有统一的 IP 地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为调用ARP来寻找某个路由器或主机的硬件地址都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的，使用方便。  



1. 在二层中我们讲了ARP协议，即已知IP地址求MAC；还有一种RARP协议，即已知MAC求IP的，你知道它可以用来干什么吗？

RARP

之前有无盘工作站，即没有硬盘的机器，无法持久化ip地址到本地，但有网卡，所以可以用RARP协议来获取IP地址。RARP可以用于局域网管理员想指定机器IP（与机器绑定，不可变），又不想每台机器去设置静态IP的情况，可以在RARP服务器上配置MAC和IP对应的ARP表，不过获取每台机器的MAC地址，好像也挺麻烦的。这个协议现在应该用得不多了吧，都用BOOTP或者DHCP了。



2.如果一个局域网里面有多个交换机，ARP 广播的模式会出现什么问题呢？

盖还说出了环路的问题。

ARP广播时，交换机会将一个端口收到的包转发到其它所有的端口上。
比如数据包经过交换机A到达交换机B，交换机B又将包复制为多份广播出去。
如果整个局域网存在一个环路，使得数据包又重新回到了最开始的交换机A，这个包又会被A再次复制多份广播出去。
如此循环，数据包会不停得转发，而且越来越多，最终占满带宽，或者使解析协议的硬件过载，行成广播风暴。





没心没肺不但说明了问题，而且说明了方案。

![img](https://static001.geekbang.org/resource/image/fa/a4/fa42fea4d9b4b8ed75008e3f1eadd7a4.png)
