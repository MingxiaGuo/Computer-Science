# 3.1 网际协议IP

网际协议 IP(Internet Protocol) 是 TCP/IP 体系中两个最主要的协议之一。与 IP 协议配套使用的还有四个协议  

* ①.地址解析协议ARP \(Address Resolution Protocol\)  : 数据链路层
* ②.逆地址解析协议RARP \(Reverse Address Resolution Protocol\)   : 数据链路层
* ③.网际控制报文协议ICMP \(Internet Control Message Protocol\)  ：网络层
* ④.网际组管理协议IGMP \(Internet Group Management Protocol\)  
  

<img src="./assets/网际层IP协议及配套协议.png" alt="网际层的 IP 协议及配套协议" style="zoom:50%;" />

如果我们只从网络层考虑问题，那么 IP 数据报就可以想象是在网络层中传送。

直接交付：指原站或路由器将IP数据报直接交给目的站，否则称间接交付。 



- IP是地址，有定位功能；MAC是身份证，无定位功能；
- CIDR可以用来判断是不是本地人；
- IP分公有的IP和私有的IP。

## 3.1.1 IP数据报格式

IP数据包格式能够说明IP协议具有什么功能。各种数据格式常以32位(4字节)为单位来描述。

首部总长:20B～60B；其中固定部分长20B；可变部分长0～40B；

* 版本：4bit，标示ipv4或ipv6, 双方使用的IP协议版本必须一致

* 首部长度：4b，可表示最大十进制数是15，以4字节为单位，故首部最长60B，若不使用任何选项，则首部长为20B。

* 区分服务：8b，实际上一直未被使用。

* 总长度：16b，以字节为单位，最大长度65535B，包括首部。

* 标识：16b，用来产生数据包标示，若数据报被分为若干片，每片的表示都一样。相同标识的分片将被重装成原来的数据报。

* 标志：3b，只有后2b有意义，最低位MF=1表示还有分片，若MF=0，表示本片是最后一片，DF=0时才允许分片。

* 片位移：占13b,标示该片在原数据中相对位置。以8字节为片移单位。

* 生存时间：8位（TTL：Time To Live） 表明数据在网络上的寿命，防止数据报在网络中丢兜圈子。以跳数为单位（最大值为255），而不是秒。指最多可经过多少个路由器，每经过一个路由器递减1。若数据报转发前TTL为0，则被丢弃。

* 协议：8b，指明上层协议，即指明携带的数据是使用何种协议。
  协议名	ICMP	IGMP	TCP	EGP	IGP	UDP	IPV6	OSPF
  协议字段值	1	2	6	8	9	17	41	89

* 首部检验和：16b，只检验数据报首部，不包括数据部分。发送方将IP首部划分为许多16位字序列，并把检验和字段置零，用反码算术运算把所有16位字相加后，将所得和的反码写入检验和字段，接收方用同样的方法计算，若结果为0，则认为正确，否则错误。

* 源地址：32b

* 目的地址：32b

【例题4.1】一个数据报总长度为3820B，其数据部分为3800B，需要分成片长不超过1420B的数据报片，则如何分片？
解：∵每个分片首部都要占20字节，故每片数据部分长度不超过1400B。于是，原始数据报被分成3片，数据部分长度分别为1400B、1400B、1000B。
原始数据报：	总长度3820B,标识12345，MF=0  DF=0 片位移 0。
分片1：		总长度1420B,标识12345，MF=1  DF=0 片位移 0。
分片2：		总长度1420B,标识12345，MF=1  DF=0 片位移 175。
分片3：		总长度1020B,标识12345，MF=0  DF=0 片位移 350。
若分片2又被分成两片，分别携带800B和600B，则这俩片的上述数据分别为：
820，12345，1，0，175；            620，12345，1，0，275 

首部的可变部分：即：可选字段及填充，可变部分若有则长度是4B的整数倍。
可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。选项字段的长度可变，从 1B～40B不等，取决于所选择的项目。
增加首部的可变部分是为了增加 IP 数据报的功能，但使IP 数据报的首部长度可变。这样就增加了每一个路由器处理数据报的开销。实际上这些选项很少使用。  
⒁、数据部分不作介绍。

## 3.1.2 IP 层转发分组的流程

1、路由表结构
路由器按网络地址来制作的，每条路由最主要的是以下两个信息：

有时也允许对特定主机指明一个路由，称为“特定主机路由”，即路由表中的目的网络号为目的主机IP。还可以采用“默认路由”（路由表的目的网络为：0.0.0.0）以减少路由表所占用的空间和搜索路由表所用的时间。
若目的网络是路由器直接相连的网络，路由表的下一跳直接交付，即把目的主机IP地址转换为目的MAC地址，把数据报封装为MAC帧后交付给目的主机；
2、分组转发算法： 
⑴、从数据报首部提取目的主机IP地址D，得目的网络地址N；
⑵、若N就是与路由器直接相连的网络，则进行直接交付，否则间接交付执行⑶；
⑶、若路由表中有目的地址为D的特定主机路由，则把数据报传给路由表指定的下一条路由器，否则转⑷；
⑷、若路由表中有到达网络N的路由，则把数据报传送给路由表中所指定的下一跳路由器，否则转⑸；
⑸、若路由器中有一默认路由，则将其转发给默认路由器，否则执行⑹；
⑹、报告转发分组出错；

## 3.1.3 IP 地址

IP地址可以通过DHCP自动分配

**IP地址是一个网卡在网络世界的通讯地址，相当于我们现实世界的门牌号码。**

以下介绍的IPV4协议定义的IP地址是一个4个字节（32位）的标识符，标示连接在Internet上的每台主机或路由接口。 

IP 地址的编址方法： 

* ①.分类的 IP 地址：这是最基本的编址方法；1981 年通过相应的标准协议。 
* ②.子网的划分：这是对最基本的编址方法的改进；1985 年通过相应的协议。 
* ③.构成超网：这是新的无分类编址方法；1993 年提出后很快被推广应用 
* 注意
  * ①.一个IP地址在英特网上必须唯一，标识了一台主机或路由接口。 
  * ②.IPV6协议的IP地址是一个16个字节（128位）的标识符；

使用ip addr命令可以显示这台机器上所有的网卡。大部分的网卡都会有一个IP地址，当然，这不是必须的。

```
root@test:~# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether fa:16:3e:c7:79:75 brd ff:ff:ff:ff:ff:ff
    inet 10.100.122.2/24 brd 10.100.122.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fec7:7975/64 scope link 
       valid_lft forever preferred_lft forever
```

例如10.100.122.2就是一个IP地址。这个地址被点分隔为四个部分，每个部分8个bit，所以IP地址总共是32位。这样产生的IP地址的数量很快就不够用了。因为当时设计IP地址的时候，哪知道今天会有这么多的计算机啊！因为不够用，于是就有了IPv6，也就是上面输出结果里面inet6 fe80::f816:3eff:fec7:7975/64。这个有128位，现在看来是够了，但是未来的事情谁知道呢？

### 3.1.3.1 IP地址的分类

本来32位的IP地址就不够，还被分成了5类。现在想想，当时分配地址的时候，真是太奢侈了。

分类的IP地址将IP地址分为若干固定的类，每类地址都有两个固定长度字段组成。 
主机号全0的ip地址表示**本网络地址**，主机号全1的ip地址表示本网络的**广播地址**，这两个ip地址都不分配给任何主机或路由接口；

lo全称是**loopback**，又称**环回接口**，往往会被分配到127.0.0.1这个地址。这个地址用于本机通信，经过内核处理后直接返回，不会在任何网络中出现。

#### 

* A类地址：第一位必须是0，前8位是网络号，后24位是主机号。
  网络号是从0～127，可指派（28－2=126）个网络，因为0.0.0.0和127.0.0.0不指派，127的网络号用作本地软件环回测试，这种地址的数据报不会在网络上出现。每个网络上最大主机数为（224－2=16777214），占整个地址空间的50%，共231个；
  【例题3.11】若IP地址5.6.7.8，则网络地址是5.0.0.0，网络号为5，主机号为6.7.8； 
* B类地址：前二位必须是10，前16位是网络号，后16位是主机号。
  网络号是从128～191，可指派（214－1=16383）个网络，因为128.0.0.0不指派。每个网络上最大主机数为（216－2=65534），占整个地址空间的25%，共230个；
* C类地址：前三位必须是110，前24位是网络号，后8位是主机号。
  	网络号是从192～223，可指派（221－1=2097151）个网络，因为192.0.0.0不指派。每个网络上最大主机数为（28－2=254），占整个地址空间的12.5%，共219个；
* D类地址：前四位是1110开头，用于多播。D类是**组播地址**。使用这一类地址，属于某个组的机器都能收到。这有点类似在公司里面大家都加入了一个邮件组。发送邮件，加入这个组的都能收到。组播地址在后面讲述**VXLAN**协议的时候会提到。
* E类地址：前4位是1111开头，保留地址。

![img](https://static001.geekbang.org/resource/image/0b/9e/0b32d6e35ff0bbc5d46cfb87f6669d9e.jpg)

在网络地址中，至少在当时设计的时候，对于A、B、 C类主要分两部分，前面一部分是网络号，后面一部分是主机号。

下面这个表格，详细地展示了A、B、C三类地址所能包含的主机的数量。在后文中，我也会多次借助这个表格来讲解。

![img](https://static001.geekbang.org/resource/image/e9/be/e9c59a4b2f0b804356759b10440ea7be.jpg)

这里面有个尴尬的事情，就是C类地址能包含的最大主机数量实在太少了，只有254个。当时设计的时候恐怕没想到，现在估计一个网吧都不够用吧。而B类地址能包含的最大主机数量又太多了。6万多台机器放在一个网络下面，一般的企业基本达不到这个规模，闲着的地址就是浪费。

**专用IP地址** 

在日常的工作中，几乎不用划分A类、B类或者C类，所以时间长了，很多人就忘记了这个分类，而只记得CIDR。但是有一点还是要注意的，就是**公有IP地址**和**私有IP地址**。

三类专用IP地址 只用于机构内部通信，又称“本地地址”**或“私有地址**”；不能作“全球地址”（又称“公有地址”；），目的地址为专用地址的数据报路由器一律不转发。

* 10.0.0.0～10.255.255.255：1段连续的A类地址（共256\*256\*256个）
* 172.16.0.0～172.31.255.255：16段连续的B类网络地址（共16\*256\*256个）
* 192.168.0.0～192.168.255.255：256段连续的C类网络地址（共256*256个）

![img](https://static001.geekbang.org/resource/image/90/93/901778433f2d6e27b916e9e53c232d93.jpg)

表格最右列是私有IP地址段。平时我们看到的数据中心里，办公室、家里或学校的IP地址，一般都是私有IP地址段。因为这些地址允许组织内部的IT人员自己管理、自己分配，而且可以重复。因此，你学校的某个私有IP地址段和我学校的可以是一样的。

这就像每个小区有自己的楼编号和门牌号，你们小区可以叫6栋，我们小区也叫6栋，没有任何问题。但是一旦出了小区，就需要使用公有IP地址。就像人民路888号，是国家统一分配的，不能两个小区都叫人民路888号。

公有IP地址有个组织统一分配，你需要去买。如果你搭建一个网站，给你学校的人使用，让你们学校的IT人员给你一个IP地址就行。但是假如你要做一个类似网易163这样的网站，就需要有公有IP地址，这样全世界的人才能访问。

表格中的192.168.0.x是最常用的私有IP地址。你家里有Wi-Fi，对应就会有一个IP地址。一般你家里地上网设备不会超过256个，所以/24基本就够了。有时候我们也能见到/16的CIDR，这两种是最常见的，也是最容易理解的。

不需要将十进制转换为二进制32位，就能明显看出192.168.0是网络号，后面是主机号。而整个网络里面的第一个地址192.168.0.1，往往就是你这个私有网络的出口地址。例如，你家里的电脑连接Wi-Fi，Wi-Fi路由器的地址就是192.168.0.1，而192.168.0.255就是广播地址。一旦发送这个地址，整个192.168.0网络里面的所有机器都能收到。

但是也不总都是这样的情况。因此，其他情况往往就会很难理解，还容易出错。

#### IP地址特点

⑴、网络号由地址管理机构分配，主机号由单位自行分配。
⑵、IP地址标识一个主机和路由接口，若主机连接在两个网络上，则必须有两个IP地址，其网络号不同。路由器用于连接网络，所以至少有两个IP地址。
⑶、具有不同网络号的局域网必须使用路由器相连。
⑷、所有网络是平等的。
⑸、当两个路由器直接相连时，互连接口可以分配IP地址，也可以不分配IP地址。
⑹、一根线相连的两个路由接口需要分配IP地址时，它们的网络号必须相同。

#### IPV6的IP地址

4、IPV6协议的IP地址是一个16个字节（128位）的标识符
在IPv6的分层地址分配方式中，高级网络管理部门可为下级网络管理部门划分地址分配区域，下级网络管理部门则可为更下层的管理部门进一步划分地址分配区域。
⑴、IPv6将用户划分成3种类型。
①.使用企业内部网络和Internet；
②.目前使用企业内部网络，将来可能会用到Internet：
③.通过家庭、飞机场、旅馆以及其他地方的电话线和Internet网络互联。
⑵、IPv6协议为这些用户提供了不同地址分配方式。 
①.4种类型的点到点通信/单播地址用于标识单一网络设备接口，单播通信传播的分组可传送到地址标识的接口。
②.改进的多播地址格式用于标识归属于不同节点的设备接口集合，多播通信传送的分组可发送到地址标识的所有接口，这种地址方式是非常有用的。例如，可将网络中发送的新消息传送给所有登记的用户。特殊的多播地址可限制在特定网络链路或特定的系统组中进行通信。IPv6协议没有定义广播地址，但可使用多播地址替代。
③.新的任意播(Anycast)地址格式IPV6协议中引入了任意播地址，用于标识属于不同节点的设备接口集合，任意播传送的分组可发送到地址标识的某一接口，接收到信息的接口通常是最近距离的网络节点，这种方式可提高路由选择的效率，网络节点可通过地址表示通信过程传输路由可经过的中间跳数，即信息传输路由可不必由路由器决定。

#### IP 地址与硬件地址
1、IP地址与MAC地址的区别：MAC地址是数据链路层和物理层使用的地址，是物理地址（硬件实现），而IP地址是网络层和以上各层使用的地址，是逻辑地址（软件实现）。





数据流向	IP首部	MAC帧首部
	源地址	目的地址	源地址	目的地址
从H1到R1	IP1	IP2	HA1	HA3
从R1到R2	IP1	IP2	HA4	HA5
从R2到H2	IP1	IP2	HA6	HA2
2、特别注意事项
⑴、在IP层抽象的互联网上只能看到IP数据报；
⑵、路由器只根据目的IP地址的网络号进行路由选择；
⑶、在局域网的链路层，只能看见MAC帧；
⑷、虽然互连网络的硬件地址体系不同，但IP层抽象的互联网屏蔽了这些下层细节；
3、没解决的二个问题
⑴、主机和路由器怎么知道应当在MAC帧的首部填入什么样的硬件地址？
⑵、路由器的路由表如何形成的？





### 3.1.3.2 划分子网

#### 4.3.1.1 从二级IP地址到三级IP地址

⑴、IP 地址设计不合理的地方：
①.IP地址空间的利用率有时很低，浪费严重；
②.为每个物理网络分配一个网络号会使路由表太大；
③.二级IP地址不够灵活，要增加一个新网络必须申请IP地址；
为解决以上问题，将2级地址中又增加一个“子网号字段”，变成三级地址，该方法称为划分子网。该方法已成标准。 

⑵、划分子网的思路：
①.划分子网是一个单位内部事情，对外仍表现为一个网络。
②.划分子网是从主机号中借用若干位作子网号；

③.外部网络发来的数据报根据网络号找到目的主机所在网络的路由器，目的主机所在网络的路由器根据目的网络号和子网号找到目的子网，把数据报交给目的主机。
【例题4.2】某单位拥有一个B类地址：145.13.0.0

划分子网前单位网络拓扑
该结构中，所有机器均在同一网络中，不利于管理，且一个局域网所接主机数量也是有限的。 

划分子网后的拓扑（假设：子网号占8位）
划分子网后，整个网络对外仍表现为一个网络，R1、R2上的路由表不必因划分子网而变动，R3根据子网转发。

#### 4.3.1.2 子网掩码 

源主机并不知目的网络是否划分子网，目的网络的路由器如何把数据报被转发到子网？借助于子网掩码。
⑴、子网掩码的定义：
①.子网掩码中的1对应于IP地址中原来的网络号和子网号，0对应主机号；
网络地址 ＝（IP 地址） AND （子网掩码） 
②.子网掩码中子网号对应部分的1可以不连续，但是推荐子网号的1连续；
【例题4.3】ip地址如下图所示，求子网地址？

⑵、子网掩码的特征
①.为了方便查找路由，即使网络没有划分子网，也要使用子网掩码。这时的子网掩码称为默认的子网掩码。1对应的网络号，0对应主机号，无子网号对应。
A类的默认子网掩码255.0.0.0
B类的默认子网掩码255.255.0.0
C类的默认子网掩码255.255.255.0
   	②.不论有没有划分子网，子网掩码与目的IP地址逐位相与得到网络地址。
③.相邻路由器交换路由信息时必须把自己所在的网络的子网掩码告诉相邻的路由器。
④.划分子网时可以采用固定长度表示子网号，此时所有子网的子网掩码相同。也可采用变长子网划分方法。 RFC(Request for Comments请求注解，介绍internet最重要的文献资源) 规定子网号全0或全1不用。但随着无分类域间路由协议CIDR的广泛使用，全0或全1的子网号也可用了。使用时看你的路由器是否支持全0和全1的子网。
⑤.划分子网的方法增加了灵活性，但也减少了能够连接网络的主机总数。
⑥.主机号全0 和全1分别表示本子网地址和广播地址，不分配给设备。
⑦. 子网位数为0、1、15、16无意义。
【例题4.4】已知ip地址141.14.72.24 子网掩码是255.255.192.0试求其网络地址，若子网掩码是255.255.255.0呢？



结论：不同的子网掩码可能得出相同的网络地址，但效果是不同的。 
【例题4.5】某单位获一c类地址192.168.12.0 现该单位的网络拓扑图如下所示，试为该单位划分子网。

解：第一步：确定子网数和子网主机数。
  	第二步：确定用的多少为标识子网号、多少为标识主机号。
本例中有5个子网，至少需3位表示网络号，主机号5位，可表示每位子网中最多可接30台主机。
子网掩码位：255.255.255.224；可以如下分配网络号：
LAN1 		192.168.12.32					LAN2 		192.168.12.64
LAN3 		192.168.12.96					LAN4 		192.168.12.128
LAN5 		192.168.12.160
损失地址数254-6*30=74个，可再建一个子网。

#### 4.3.2 使用子网时分组转发过程

划分子网后，路由表必须包含3项内容：目的网络、子网掩码和下一跳地址；
1、路由转发分组的算法：
⑴、从收到的数据报首部提取目的IP地址D；
⑵、先判断是否为直接交付。若是，则进行直接交付；
⑶、若路由表中有目的地址为D的特定主机路由，则按路由表中指明的下一跳路由作为转发对象；
⑷、对路由表中的每一行，用其中的子网掩码和D逐位相与，其结果为网络地址N，若N与该行目的网络地址匹配，则把数据报传送给该行指明的下一跳路由器，否则执行⑸；
⑸、若表中有一默认路由，则把数据报传送给路由表中所指明的默认路由器，否则执行⑹；
⑹、报告转发分组出错；	
【例题4.6】已知互联网和路由器 R1 中的路由表。主机 H1 向 H2 发送分组。试讨论 R1 收到 H1向 H2 发送的分组后查找路由表的过程。 

解：现讨论H1想H2发送分组的过程： 
H1把本子网掩码与H2的IP 地址逐位相与得128.30.33.128 它不等于H1的网络地址，这说明H2与H1不在同一子网上，故H1把分组交给子网默认的路由器R1；
R1收到分组后，先找路由表第一行，取其目的网路地址和子网掩码相与后得到目的子网地址，看它是否和收到分组的子网地址匹配，若匹配则转发到下一跳接口，否则再找第二行，进行类似操作，最后R1把分组从接口1直接交付给主机H2。

### 3.1.3.3 构造超网

构造超网: 无分类编址 CIDR

CIDR  无类域内路由选择（Classless Inter-Domain Routing）



这里面有个尴尬的事情，就是C类地址能包含的最大主机数量实在太少了，只有254个。当时设计的时候恐怕没想到，现在估计一个网吧都不够用吧。而B类地址能包含的最大主机数量又太多了。6万多台机器放在一个网络下面，一般的企业基本达不到这个规模，闲着的地址就是浪费。

## 无类型域间选路（CIDR）

于是有了一个折中的方式叫作**无类型域间选路**，简称**CIDR**。这种方式打破了原来设计的几类地址的做法，将32位的IP地址一分为二，前面是**网络号**，后面是**主机号**。从哪里分呢？你如果注意观察的话可以看到，10.100.122.2/24，这个IP地址中有一个斜杠，斜杠后面有个数字24。这种地址表示形式，就是CIDR。后面24的意思是，32位中，前24位是网络号，后8位是主机号。

伴随着CIDR存在的，一个是**广播地址**，10.100.122.255。如果发送这个地址，所有10.100.122网络里面的机器都可以收到。另一个是**子网掩码**，255.255.255.0。

将子网掩码和IP地址进行AND计算。前面三个255，转成二进制都是1。1和任何数值取AND，都是原来数值，因而前三个数不变，为10.100.122。后面一个0，转换成二进制是0，0和任何数值取AND，都是0，因而最后一个数变为0，合起来就是10.100.122.0。这就是**网络号**。**将子网掩码和IP地址按位计算AND，就可得到网络号。**



## 举例：一个容易“犯错”的CIDR

我们来看16.158.165.91/22这个CIDR。求一下这个网络的第一个地址、子网掩码和广播地址。

你要是上来就写16.158.165.1，那就大错特错了。

/22不是8的整数倍，不好办，只能先变成二进制来看。16.158的部分不会动，它占了前16位。中间的165，变为二进制为‭10100101‬。除了前面的16位，还剩6位。所以，这8位中前6位是网络号，16.158.<101001>，而<01>.91是机器号。

第一个地址是16.158.<101001><00>.1，即16.158.164.1。子网掩码是255.255.<111111><00>.0，即255.255.252.0。广播地址为16.158.<101001><11>.255，即16.158.167.255。

#### 4.3.3.1 网路前缀

⑴、因特网仍面临着三个必须尽早解决的问题
尽管划分子网在一定程度上缓解了因特网发展中遇到的困难，但因特网仍面临着三个必须尽早解决的问题：

* ①.B类地址很快全部分配完毕；
* ②.主干网上路由表的表项急剧增大
* ③.IPV4地址空间最终将消耗 
  在变长子网掩码基础上发展起来的CIDR技术已成为因特网建议的标准协议。
  ⑵、CIDR最主要的特点
  ①.CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。CIDR编址方法如下：

②.CIDR使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号。使用“斜线记法”，即在IP地址后加上斜线“/”,然后写上网络前缀所占位数，故斜线表示法中，斜线后面的数字就是掩码中1 的个数IP 地址从三级编址（使用子网掩码）又回到了两级编址。
③.把网络前缀都相同的连续IP地址组成一个“CIDR地址块”；
⑶、CIDR地址块已知CIDR地址块中任一地址，就可以知道这个地址块的起始地址、最大地址以及该地址块中地址总数。
【例题4.7】128.14.35.7/20 
128.14.35.7=1000 0000 0000 1110 0010 0011 0000 0111
可知最小地址为128.14.32.0
最大地址为128.14.47.255
该地址块共有212个地址。
⑷、CIDR 记法的其他形式
①.10.0.0.0/10 可简写为 10/10，也就是把点分十进制中低位连续的 0 省略。 
②.ip地址为10.0.0.0，掩码为255.192.0.0
③.网络前缀的后面加一个星号 * 的表示方法
   在星号 * 之前是网络前缀，星号 * 表示 IP 地址中的主机号，可以是任意值。如 00001010 00* ；
⑸、路由聚合(route aggregation) 
①.一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的一个项目可以表示很多个原来传统分类地址的路由。
②.路由聚合也称为构成超网(supernetting)。
③.CIDR 虽然不使用子网了，但仍然使用“掩码”这一名词（但不叫子网掩码）。
④. 为便于路由选择，CIDR使用32位的地址掩码，1对应网络前缀位，0对应主机位。如：/20地址块，它的掩码是 20 个连续的 1。 
【例题4.8】某组织分配到地址块/20，可以再从主机号中借3位来划分8个子网，每个子网网络掩码为/23.
路由器利用CIDR地址块查找目的网络，使用路由聚合技术可减少路由表项目。
【例题4.9】若192.168.4.0/24、192.168.5.0/24、192.168.6.0/24,可聚合成一条路由192.168.4.0/22,当然前提是这三个网络在该路由器上的路由相同。
若有192.168.7.0/24与它们路由不同，则不能合并成192.168.4.0/22,而只能把192.168.4.0/24与192.168.5.0/24合并成192.168.4.0/23,而192.168.6.0/24与192.168.7.0/24各自为一个单独的表项。 
⑹、CIDR地址块的子网划分
   分配到CIDR地址块的组织，仍可以在本组织内根据需要划分子网。子网也只有网络前缀和主机号，只是子网前缀比整个组织网络前缀要长一些。
【例题4.10】某ISP（Internet Service Provider互联网服务提供商）已拥有地址块206.0.64.0/18，现某大学需要800个IP地址，ISP可给该大学一个地址块206.0.68.0/22，含1024个IP 地址。这个大学可自由对本校的各系分配地址块，各系还可在划分本系的地址块。

解 ①.一系向学校申请512个地址，需9位表示主机号，故从206.0.68.0/23开始，到2060.0.69.255/23,都作为一系地址。②.二系向学校申请256个地址，需8位表示主机号，只能从206.0.70.0/24开始分配，此时206.0.71.0/24没有分出去，这有256个地址。③.三系和四系分别申请128个地址，需再拿一位区别三系和四系。
注意这个 ISP 共有 64 个 C 类网络。如果不采用 CIDR 技术，则在与该 ISP 的路由器交换路由信息的每一个路由器的路由表中，就需要有 64 个项目。但采用地址聚合后，只需用路由聚合后的 1 个项目 206.0.64.0/18 就能找到该 ISP。 

#### 4.3.3.2 最长前缀匹配

最长前缀匹配 又称为最长匹配或最佳匹配

⑴、使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能会得到不止一个匹配结果。 
⑵、应当从匹配结果中选择具有最长网络前缀的路由最长前缀匹配；
⑶、网络前缀越长，其地址块就越小，因而路由就越具体；
说明如果IP地址分配一开始就采用CIDR，那么我们可以按网络所在地理位置来分配地址块，这样可大大减少路由表中项目。但现在要收回已发地址已十分困难。
【例题4.11】如下图所示

显然：选择两个匹配的地址中更具体的一个，即选择最长前缀的地址。 

#### 4.3.3.3 用二叉线索树查找路由表

⑴、为了进行更加有效的查找，通常是将无分类编址的路由表存放在一种层次的数据结构中，然后自上而下地按层次进行查找。这里最常用的就是二叉线索；
⑵、IP 地址中从左到右的比特值决定了从根结点逐层向下层延伸的路径，而二叉线索中的各个路径就代表路由表中存放的各个地址。
⑶、为了提高二叉线索的查找速度，广泛使用了各种压缩技术。   
⑷、唯一前缀即表中所有的IP地址中，该前缀是唯一的；利用唯一前缀构造二叉线索；

匹配时只需匹配唯一前缀（表中所有的IP地址中，该前缀是唯一的），而不必匹配全部32位。当网络唯一前缀匹配后，在进行一次32位的匹配，在每个叶结点中包含对应的网络前缀和子网掩码，搜索到叶结点后，将目的地址与子网掩码相与，再看与网络前缀是否匹配。







---



## 补充

\1. IP设计时犯的错误？

低估了未来网络的发展，32位地址不够用。于是有了现在IPv6（128位）
分类错误。分成了5类。C类太少，B类太多。C类254个，网络都不够；D类6万多，给企业都太多。

\2. 那后来者如何弥补IP设计者犯的错误呢？

CIDR，无类型域间选路。
打破原来几类地址设计的做法，将32位IP地址一分二，前者网络号，后者主机号。
如何分呢？
栗子：10.100.122.2/24
24 = 前24位是网络号，那么后8位就是主机号。
那如何用？
如发送行信息给 10.100.122.255
所有以 10.100.122... 开头的机器都能收到。
于是有了两个概念：
广播地址：10.100.122.255
子网掩码：255.255.255.0 -> AND 得到网络号。

\3. 每一个城市都有人民广场，IP设计是如何解决的？

公有IP地址和私有IP地址。
搭建世界人民都可以访问的网站，需要共有IP地址
搭建只有学校同学使用饿的网站，只要私有IP地址
例子1: Wi-Fi
192.168.0.x 是最常用的私有 IP 地址
192.168.0 是网络号
192.168.0.1，往往就是你这个私有网络的出口地址
192.168.0.255 就是广播地址。一旦发送这个地址，整个 192.168.0 网络里面的所有机器都能收到。

例子2: 16.158.165.91/22

\4. 如何理解MAC地址？

如果说IP是地址，有定位功能。那Mac就是身份证，唯一识别。

\## 琐碎：

\5. 讲了ABC，那是D类是什么？

D 类是组播地址。使用这一类地址，属于某个组的机器都能收到。这有点类似在公司里面大家都加入了一个邮件组。发送邮件，加入这个组的都能收到。组播地址在后面讲述 VXLAN 协议的时候会提到。

\6. IP地址scope是什么意思？

对于 eth0 这张网卡来讲，是 global，说明这张网卡是可以对外的，可以接收来自各个地方的包。对于 lo 来讲，是 host，说明这张网卡仅仅可以供本机相互通信。

\7. 那lo是什么意思？

lo 全称是loopback，又称环回接口，往往会被分配到 127.0.0.1 这个地址。这个地址用于本机通信，经过内核处理后直接返回，不会在任何网络中出现。

\8. < BROADCAST,MULTICAST,UP,LOWER_UP > 是干什么的？

net_device flags，网络设备的状态标识。
UP 表示网卡处于启动的状态；
BROADCAST 表示这个网卡有广播地址，可以发送广播包；
MULTICAST 表示网卡可以发送多播包；
LOWER_UP 表示 L1 是启动的，也即网线插着呢。

\9. MTU1500 是指什么意思呢？是哪一层的概念？

最大传输单元 MTU 为 1500，这是以太网的默认值。
MTU 是二层 MAC 层的概念。MAC 层有 MAC 的头，以太网规定连 MAC 头带正文合起来，不允许超过 1500 个字节。

\10. qdisc pfifo_fast 是什么意思呢？

排队规则。规定数据包如何进出的。有pfifo, pfifo_fast.





MTU 大小是不包含二层头部和尾部的，MTU 1500表示二层MAC帧大小不超过1518. MAC 头14 字节，尾4字节。可以抓包验证

猴哥

现在很多工具都可以更改本机的MAC地址，也就是网络上存在很多MAC地址被更改成一样的，然而并没有出现通讯异常或者混乱这是为什么？

这是一个别人的留言，老师回答了会出问题，但没回答为什么？
MAC在一个局域网内冲突才会影响网络通讯，局域网外是通过IP定位，所以不同局域网的网络设备MAC一样是不会有通讯问题的。



----

1.A、B、C类地址的有效地址范围是多少？

？

![img](https://static001.geekbang.org/resource/image/eb/c5/ebf13d11cb0bc03d520c6cc4796ee8c5.png)

A B C 类别表里A类数据有问题 应该是1:0:0:1-126:255:255:254 建议检查以下B 和C类

2018-06-01 21:13

作者回复

(⊙o⊙)哇，好严谨。A类IP的地址第一个字段范围是0~127，但是由于全0和全1的地址用作特殊用途，实际可指派的第一个字段范围是1~126。所以仔细搜了一下，如果较真的考试题的说法是，A类地址范围和A类有效地址范围。

我在写的时候，没有考虑这么严谨，平时使用地址的时候，也是看个大概的范围。所以这里再回答一下。

A类IP的地址第一个字段范围是0～127，但是由于全0和全1的地址用作特殊用途，实际可指派的范围是1～126。所以我仔细查了一下，如果较真的话，你在答考试题的时候可以说，A类地址范围和A类有效地址范围。



----





2.网络号、IP地址、子网掩码和广播地址的先后关系是什么？

？

![img](https://static001.geekbang.org/resource/image/25/56/254f28a3623ca8b4ee368ac02f0cf656.png)

当在一个数据中心或者一个办公室规划一个网络的时候，首先是网络管理员规划网段，一般是根据将来要容纳的机器数量来规划，一旦定了，以后就不好变了。

假如你在一个小公司里，总共就没几台机器，对于私有地址，一般选择192.168.0.0/24就可以了。

这个时候先有的是网络号。192.168.0就是网络号。有了网络号，子网掩码同时也就有了，就是前面都是网络号的是1，其他的是0，广播地址也有了，除了网络号之外都是1。

当规划完网络的时候，一般这个网络里面的第一个、第二个地址被默认网关DHCP服务器占用，你自己创建的机器，只要和其他的不冲突就可以了，当然你也可以让DHCP服务自动配置。

规划网络原来都是网络管理员的事情。有了公有云之后，一般有个概念虚拟网络（VPC），鼠标一点就能创建一个网络，网络完全软件化了，任何人都可以做网络规划。





---

3.组播和广播的意义和原理是什么？

？

![img](https://static001.geekbang.org/resource/image/92/f1/92654ed9549bba6c4e609e256ba083f1.png)

C类地址的主机号8位，去掉0和255，就只有254个了。

在《TCP/IP详解》这本书里面，有两章讲了广播、多播以及IGMP。广播和组播分为两个层面，其中MAC层有广播和组播对应的地址，IP层也有自己的广播地址和组播地址。

广播相对比较简单，MAC层的广播为ff:ff:ff:ff:ff:ff，IP层指向子网的广播地址为主机号为全1且有特定子网号的地址。

组播复杂一些，MAC层中，当地址中最高字节的最低位设置为1时，表示该地址是一个组播地址，用十六进制可表示为01:00:00:00:00:00。IP层中，组播地址为D类IP地址，当IP地址为组播地址的时候，有一个算法可以计算出对应的MAC层地址。

多播进程将目的IP地址指明为多播地址，设备驱动程序将它转换为相应的以太网地址，然后把数据发送出去。这些接收进程必须通知它们的IP层，它们想接收的发给定多播地址的数据报，并且设备驱动程序必须能够接收这些多播帧。这个过程就是“加入一个多播组”。

当多播跨越路由器的时候，需要通过IGMP协议告诉多播路由器，多播数据包应该如何转发。



---

4.MTU 1500的具体含义是什么？

![img](https://static001.geekbang.org/resource/image/0b/3d/0b43a6d8c1b77daef705e6b08f40a43d.png)

MTU（Maximum Transmission Unit，最大传输单元）是二层的一个定义。以以太网为例，MTU为1500个Byte，前面有6个Byte的目标MAC地址，6个Byte的源MAC地址，2个Byte的类型，后面有4个Byte的CRC校验，共1518个Byte。

在IP层，一个IP数据报在以太网中传输，如果它的长度大于该MTU值，就要进行分片传输。如果不允许分片DF，就会发送ICMP包，这个在[ICMP](https://time.geekbang.org/column/article/8445)那一节讲过。

在TCP层有个MSS（Maximum Segment Size，最大分段大小），它等于MTU减去IP头，再减去TCP头。即在不分片的情况下，TCP里面放的最大内容。

在HTTP层看来，它的body没有限制，而且在应用层看来，下层的TCP是一个流，可以一直发送，但其实是会被分成一个个段的。

----

鲸息

MTU1500是指 mac 层的有效载荷长度还是mac 头加上有效载荷长度呢？看一些资料都说是 mac 的有效载荷。
