### 4.6.1 IP 多播的基本概念

### 4.6.2 在局域网上进行硬件多播

### 4.6.3 因特网组管理协议 IGMP 和多播路由选择协议

4.6.1、IP多播的基本概念
与单播相比，多播可大大节约网络资源
  	例如：视频服务器用单播方式向90个主机传送同样的视频节目，若用单播方式，服务器需要发送90个单播，即同一视频分组需要发送90个副本。若采用多播方式，只需发送1次分组，当分组到达目的局域网时，因为网络有硬件多播功能，不需要复制分组，在中途的路由器上只需要复制少量副本。如下图所示：
 
因特网范围的多播要靠运行多播协议的多播路由器来实现。多播路由器当然也可以转发普通的IP数据报。在因特网上进行多播称“IP多播”， 
说明	⑴、多播数据报的目的地址不能写入某个主机的IP地址，原因是同一时间可能有成千上万的主机加入同一多播组。IP多播需要使用多播IP地址，即目的地主应写入多播组的标识符，即IP地址中的D类地址；
⑵、D类地址以1110开头，从224.0.0.0到239.255.255.255 。显然D类地址不能用于源地址，对多播数据报不产生ICMP差错报文，故PING命令后加多播地址，不会收到响应。D类地址中有些地址已经被IANA指派为永久组地址，只有224.0.1.0至238.255.255.255范围内IP地址可用作全球范围内的多播地址（参见P165）。
⑶、IP多播分两种①.一种只是在局域网上进行硬件多播；
②.另一种则在因特网范围内进行多播。
4.6.2、在局域网上进行硬件多播
IANA（英特网号码指派管理局）拥有的以太网地址块的高24位为 00–00–5E ，因此TCP/IP协议使用的以太网多播地址块的范围是00–00–5E-00-00-00到00-00-5E-FF-FF-FF 。
IANA拥有的以太网多播地址范围从01-00-5E-00-00-00到01-00-5E-7F-FF-FF；每一个地址中，只有23位可用作多播地址。D类地址的低23位与其构成一一对应关系。故不同的IP多播地址，有可能对应的硬件多播地址相同。
收到多播数据报的主机，要在IP层利用软件进行过滤。 
 

4.6.3、网际组管理协议IGMP和多播路由选择协议
1、IP多播需要的两种协议 IGMP协议 和多播路由选择协议
⑴、为了使路由器知道多播组成员的信息，这就需要利用网际组管理协议 IGMP (Internet Group Management Protocol)。
⑵、连接在局域网上的多播路由器还必须和因特网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员，这就需要使用多播路由选择协议。
注意①.IGMP并非对因特网范围内所有多播组成员进行管理的协议。IGMP不知道IP多播组有多少成员，分布在哪些网络。除IGMP外，局域网上多播路由器还要于Internet上其他多播路由器协同工作，这就需要多播路由选择协议；
②.多播转发必须动态适应多播组成员变化；
③.没有参加任何多播组的主机，可以向任意多播组发送多播数据；
④.多播数据报也可通过没有组成员接入的网络；
2、网际组管理协议IGMP 
IGMP不是一个单独的协议，而是整个IP一个组成部分；
⑴、IGMP工作分两个阶段  
①.第一阶段当某主机想加入一个新多播组时，该主机向多播组的多播地址发送一个IGMP报文，声称自己想要成为该组成员。本地多播路由器收到该IGMP报文后，利用多播路由选择协议把这种组成员关系转发给因特网上其他多播路由器。
②.第二阶段本地多播路由器要周期性地探寻本地局域网上的主机，以便知道这些主机是否还继续是组的成员。只要有一个主机响应，那么多播路由器就认为该组是活跃的。若几次探寻均无回应，则认为本网络主机已全部离开该组。则不再将该组成员关系转给其他多播路由器。
⑵、IGMP采用以下措施 
①.在主机和多播路由器之间所有通信均使用IP多播；
②.多播路由器探寻组成员关系时，只需要对所有组发送一个询问报告，不必对每组发送一个询问报文。询问频率每125秒发送一次；
③.当同一网络上有几个多播路由器时，它们迅速选择其中一个来探寻主机的成员关系；
④.在IGMP的询问报文中有一个数值N，它指明一个最长响应时间（默认为10秒），收到询问时，主机在0到N之间随机选择发送响应所需时延。若一个主机同时参加了几个多播组，则主机对每一个多播组选择不同的随机数。
⑤.同一组内的每一个主机都要监听响应，只要有本组的其他主机选发送了响应，自己就可以不再发送响应了。若一个主机上有很多进程加入了某个多播组，那么这个主机对发给这个多播组的每个多播数据报只接收一个副本，然后主机的每一个进程发送一个本地复制的副本。
3、多播路由选择协议
⑴、多播路由选择实际上就是要找出以源主机为根节点的多播转发树，该树上的叶子节点就是要受到多播数据报的主机；
注意不同多播组有不同多播转发树，同一多播组对不同的源点，也会有不同的多播转发树。 
⑵、多播路由选择协议在转发多播数据报时使用三种方法 	
①.洪泛与剪除（适合小多播组，且各成员所在的局域网相邻）	
反向路径广播RPB策略每个路由器在收到一个多播数据报时，先检查数据报是否从源点经最短路径传来的？若是，则向所有其它方向转发刚才收到的多播数据报（进入的方向除外），否则，丢弃该数据报。
   如果转发树上某个路由器发现它的下游树枝已没有该多播组的成员，就把它和下游树枝一起剪除（参见P169图4-50）。
②.隧道技术（适合地理位置分散的多播组）
 
   若R1和R2中间的网络不支持多播，可使用隧道技术，转成单播数据报，从R1发送到R2 。
③.基于核心的发现技术（大小范围都适合）
   对于每个多播组G，指定一个核心路由器，给出它的IP单播地址。核心路由器创建出对应于多播组G的转发树，如果有R1向核心路由器发送数据报，途中每个路由器都要检查其内容。当数据报到达该组中路由器R2时，R2处理该数据报。若该数据报是多播数据报，则R2向G中成员转发该数据报，若是请求加入G的数据报，则R2将该信息加入路由中，并用隧道技术向R1发送每个数据报副本。
⑶、几种多播路由选择协议  
①.距离向量多播路由选择协议 DVMRP (Distance Vector Multicast Routing Protocol)
②.基于核心的转发树 CBT (Core Based Tree)
③.开放最短通路优先的多播扩展 MOSPF (Multicast Extensions to OSPF) 
④.协议无关多播-稀疏方式 PIM-SM(Protocol Independent Multicast-Sparse Mode)
⑤.协议无关多播-密集方式 PIM-DM(Protocol Independent Multicast-Dense Mode)


